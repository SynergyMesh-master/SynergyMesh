name: Self-Healing Path Validation

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'core/contract_service/contracts-L1/contracts/src/**'
      - 'governance/40-self-healing/**'
      - '.github/workflows/self-healing-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'core/contract_service/contracts-L1/contracts/src/**'
      - 'governance/40-self-healing/**'

permissions:
  contents: read
  pull-requests: write
  actions: read
  issues: write

jobs:
  setup-and-build:
    name: è¨­ç½®èˆ‡å»ºç½®
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        id: install
        continue-on-error: true
        run: |
          npm ci
          cd core/contract_service/contracts-L1/contracts && npm ci
      
      - name: Type check
        id: typecheck
        continue-on-error: true
        run: |
          cd core/contract_service/contracts-L1/contracts
          npm run typecheck
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="å»ºç½®èˆ‡åž‹åˆ¥æª¢æŸ¥: é€šéŽ"
          
          if [ "${{ steps.install.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="ä¾è³´å®‰è£å¤±æ•—"
          elif [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            STATUS="warning"
            MESSAGE="åž‹åˆ¥æª¢æŸ¥æœ‰è­¦å‘Š (éžé˜»æ–·)"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  validate-policies:
    name: é©—è­‰æ²»ç†ç­–ç•¥
    runs-on: ubuntu-latest
    needs: setup-and-build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd core/contract_service/contracts-L1/contracts && npm ci
      
      - name: Type check
        run: |
          cd core/contract_service/contracts-L1/contracts
          npm run typecheck || echo "Type check warnings (non-blocking)"
      
      - name: Validate governance policies
        id: validate-gov
        continue-on-error: true
        run: |
          if [ -f "tools/docs/validate_index.py" ]; then
            python3 tools/docs/validate_index.py --verbose
          fi
      
      - name: Check self-healing policy exists
        id: check-policy
        continue-on-error: true
        run: |
          if [ ! -f "governance/40-self-healing/policies/path-validation-self-healing.yaml" ]; then
            echo "âŒ Self-healing policy file missing"
            exit 1
          fi
          echo "âœ… Self-healing policy file found"
      
      - name: Validate YAML syntax
        id: validate-yaml
        continue-on-error: true
        run: |
          if command -v yamllint &> /dev/null; then
            yamllint governance/40-self-healing/policies/path-validation-self-healing.yaml
          else
            echo "yamllint not installed, skipping YAML validation"
          fi
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="ç­–ç•¥é©—è­‰: é€šéŽ"
          
          if [ "${{ steps.validate-gov.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="æ²»ç†ç­–ç•¥é©—è­‰å¤±æ•—"
          elif [ "${{ steps.check-policy.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="è‡ªæˆ‘ä¿®å¾©ç­–ç•¥æª”æ¡ˆç¼ºå¤±"
          elif [ "${{ steps.validate-yaml.outcome }}" != "success" ]; then
            STATUS="warning"
            MESSAGE="YAML èªžæ³•é©—è­‰æœ‰è­¦å‘Š"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  validate-files:
    name: é©—è­‰æª”æ¡ˆçµæ§‹
    runs-on: ubuntu-latest
    needs: setup-and-build
    outputs:
      summary: ${{ steps.summary.outputs.text }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check documentation
        id: check-docs
        continue-on-error: true
        run: |
          if [ ! -f "core/contract_service/contracts-L1/contracts/docs/SELF_HEALING_ARCHITECTURE.md" ]; then
            echo "âŒ Self-healing documentation missing"
            exit 1
          fi
          echo "âœ… Self-healing documentation found"
      
      - name: Verify event system files
        id: check-files
        continue-on-error: true
        run: |
          FILES=(
            "core/contract_service/contracts-L1/contracts/src/events/path-validation-events.ts"
            "core/contract_service/contracts-L1/contracts/src/utils/self-healing-path-validator.ts"
            "core/contract_service/contracts-L1/contracts/src/governance/self-healing-integration.ts"
          )
          
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing file: $file"
              exit 1
            fi
          done
          echo "âœ… All self-healing files present"
      
      - name: Create summary
        id: summary
        if: always()
        run: |
          STATUS="success"
          MESSAGE="æª”æ¡ˆçµæ§‹: å®Œæ•´"
          
          if [ "${{ steps.check-docs.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="è‡ªæˆ‘ä¿®å¾©æ–‡æª”ç¼ºå¤±"
          elif [ "${{ steps.check-files.outcome }}" != "success" ]; then
            STATUS="failure"
            MESSAGE="äº‹ä»¶ç³»çµ±æª”æ¡ˆç¼ºå¤±"
          fi
          
          echo "text={\"status\":\"$STATUS\",\"message\":\"$MESSAGE\"}" >> $GITHUB_OUTPUT
  
  # Consolidated report job - gathers all job results
  report:
    name: ðŸ“Š æ•´åˆå ±å‘Š
    runs-on: ubuntu-latest
    needs: [setup-and-build, validate-policies, validate-files]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare job summaries
        id: prepare
        run: |
          # Build JSON with all job summaries
          cat > job-summaries.json <<EOF
          {
            "setup-and-build": ${{ needs.setup-and-build.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }},
            "validate-policies": ${{ needs.validate-policies.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }},
            "validate-files": ${{ needs.validate-files.outputs.summary || '{"status":"unknown","message":"ç„¡æ‘˜è¦"}' }}
          }
          EOF
          
          cat job-summaries.json
          
          # Determine overall status
          OVERALL_STATUS="success"
          if [ "${{ needs.setup-and-build.result }}" == "failure" ] || \
             [ "${{ needs.validate-policies.result }}" == "failure" ] || \
             [ "${{ needs.validate-files.result }}" == "failure" ]; then
            OVERALL_STATUS="failure"
          elif [ "${{ needs.setup-and-build.result }}" == "cancelled" ] || \
               [ "${{ needs.validate-policies.result }}" == "cancelled" ] || \
               [ "${{ needs.validate-files.result }}" == "cancelled" ]; then
            OVERALL_STATUS="failure"
          fi
          
          echo "overall-status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "job-summaries=$(cat job-summaries.json | jq -c .)" >> $GITHUB_OUTPUT
      
      - name: Call consolidated report workflow
        if: github.event_name == 'pull_request'
        uses: ./.github/workflows/ci-consolidated-report.yml
        with:
          ci-name: 'Self-Healing Path Validation'
          job-summaries: ${{ steps.prepare.outputs.job-summaries }}
          workflow-run-id: ${{ github.run_id }}
          commit-sha: ${{ github.sha }}
          overall-status: ${{ steps.prepare.outputs.overall-status }}
          pr-number: ${{ github.event.pull_request.number }}
        secrets:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate structure report (for artifact)
        run: |
          echo "## Self-Healing Architecture Validation Report" > self-healing-report.md
          echo "" >> self-healing-report.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> self-healing-report.md
          echo "**Commit:** ${{ github.sha }}" >> self-healing-report.md
          echo "**Status:** ${{ steps.prepare.outputs.overall-status }}" >> self-healing-report.md
          echo "" >> self-healing-report.md
          echo "### Job Results" >> self-healing-report.md
          echo "- Setup & Build: ${{ needs.setup-and-build.result }}" >> self-healing-report.md
          echo "- Validate Policies: ${{ needs.validate-policies.result }}" >> self-healing-report.md
          echo "- Validate Files: ${{ needs.validate-files.result }}" >> self-healing-report.md
          echo "" >> self-healing-report.md
          echo "### Architecture Principles" >> self-healing-report.md
          echo "1. **æ‰¿è¥²çµæ§‹ (Inherited Structure)**: DAG-based recovery with governance rules" >> self-healing-report.md
          echo "2. **çŸ­æš«ç­–ç•¥ (Transient Strategy)**: Temporary repair during failures" >> self-healing-report.md
          echo "3. **è‡ªæˆ‘ä¿®å¾© (Self-Repair)**: Automatic structure completion" >> self-healing-report.md
      
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: self-healing-validation-report
          path: self-healing-report.md
          retention-days: 30
