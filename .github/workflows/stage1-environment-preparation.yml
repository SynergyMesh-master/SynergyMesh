name: Stage 1 - Environment Preparation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

jobs:
  config-validation:
    name: âœ… Config syntax validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate YAML/JSON
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import pathlib
          import sys
          import yaml

          root = pathlib.Path(".")
          yaml_files = list(root.glob("**/*.yml")) + list(root.glob("**/*.yaml"))
          json_files = list(root.glob("**/*.json"))

          errors = []
          for path in yaml_files:
            if ".git" in path.parts or "node_modules" in path.parts or "archive" in path.parts or "templates-disabled" in path.parts or "workspace-archive" in path.parts or "workspace-problematic" in path.parts:
              continue
            try:
              content = path.read_text()
              list(yaml.safe_load_all(content))
            except Exception as exc:
              errors.append(f"YAML error in {path}: {exc}")

          for path in json_files:
            if ".git" in path.parts or "node_modules" in path.parts or "archive" in path.parts or "templates-disabled" in path.parts or "workspace-archive" in path.parts or "workspace-problematic" in path.parts:
              continue
            try:
              content = path.read_text()
              json.loads(content)
            except Exception as exc:
              errors.append(f"JSON error in {path}: {exc}")

          if errors:
            print("Validation failed:")
            for err in errors:
              print(f"- {err}")
            sys.exit(1)
          else:
            print(f"Validated {len(yaml_files)} YAML and {len(json_files)} JSON files")
          PY
