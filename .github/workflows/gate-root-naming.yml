name: ðŸšª Root Naming Policy Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    paths:
      - root.*
      - init.d/**
      - bin/**
      - sbin/**
      - etc/**
      - lib/**
      - var/**
      - usr/**
      - controlplane/baseline/**
      - workspace/config/**

permissions:
  contents: read
  pull-requests: write

jobs:
  validate_root_naming:
    name: ðŸ” é©—è­‰ root/ å‘½åè¦ç¯„
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2

      - name: ðŸ” æª¢æŸ¥ root å‘½å
        run: |
          set -euo pipefail
          root_dir="$(pwd)"
          violations=0
          check_name() {
            local path="$1"
            local base="$2"
            if [[ "$base" =~ [A-Z] ]]; then
              echo "âŒ æ–‡ä»¶å«æœ‰å¤§å¯«å­—æ¯: $path" >> "$GITHUB_STEP_SUMMARY"
              violations=$((violations+1))
            fi
            if [[ "$base" == *" "* ]]; then
              echo "âŒ æ–‡ä»¶å«æœ‰ç©ºç™½: $path" >> "$GITHUB_STEP_SUMMARY"
              violations=$((violations+1))
            fi
          }
          targets=(root.* init.d bin sbin etc lib var usr controlplane/baseline workspace/config)
          for pattern in "${targets[@]}"; do
            mapfile -t matched_paths < <(compgen -G "$pattern" || true)
            if [ ${#matched_paths[@]} -eq 0 ]; then
              continue
            fi

            for candidate in "${matched_paths[@]}"; do
              abs_path="$(realpath "$candidate" 2>/dev/null || true)"
              [ -n "$abs_path" ] || continue
              case "$abs_path" in
                "$root_dir"/*) ;;
                *)
                  echo "âš ï¸ è·³éŽè¶…å‡ºå·¥ä½œå€çš„è·¯å¾‘: $candidate" >> "$GITHUB_STEP_SUMMARY"
                  continue
                  ;;
              esac

              if [ -d "$abs_path" ]; then
                while IFS= read -r -d '' file; do
                  basename=$(basename "$file")
                  check_name "$file" "$basename"
                done < <(find -P "$abs_path" -maxdepth 3 -type f -print0)
              else
                basename=$(basename "$abs_path")
                check_name "$abs_path" "$basename"
              fi
            done
          done

          if [ $violations -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æª”æ¡ˆç¬¦åˆå‘½åè¦ç¯„" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ç¸½è¨ˆ $violations é …å‘½åé•è¦" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
