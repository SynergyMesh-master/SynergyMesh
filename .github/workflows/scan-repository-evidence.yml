name: ðŸ” Repository Evidence Scanner - å…¨å„²å­˜åº«è­‰æ“šæŽƒæ

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      output_format:
        description: 'Output format (console or json)'
        required: false
        default: 'console'
        type: choice
        options:
          - console
          - json
  
  # Scheduled scan (weekly)
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  
  # On push to main (for monitoring purposes)
  push:
    branches: [main]
    paths:
      - '**/*.md'
      - '**/*.yml'
      - '**/*.yaml'

env:
  AGENT_CONTRACT_ENFORCEMENT: true
  EVIDENCE_SCANNING: true

jobs:
  scan-repository:
    name: ðŸ” æŽƒæå…¨å„²å­˜åº«è­‰æ“šåˆè¦æ€§
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: ðŸ” Run Evidence Scanner
        id: scan
        run: |
          echo "ðŸšª PR Evidence Gate - å…¨å„²å­˜åº«æŽƒæ"
          echo ""
          
          # Always use JSON output for reliable metric extraction
          node .github/scripts/scan-repository-evidence.js --json > scan-results.json
          EXIT_CODE=$?
          
          # Display results based on user preference
          if [ "${{ github.event.inputs.output_format }}" = "json" ]; then
            cat scan-results.json
          else
            # Also run with console output for human-readable display
            node .github/scripts/scan-repository-evidence.js 2>&1 | tee scan-output.txt || true
          fi
          
          # Extract metrics from JSON (reliable parsing)
          ERRORS=$(jq '.summary.errors' scan-results.json)
          WARNINGS=$(jq '.summary.warnings' scan-results.json)
          TOTAL=$(jq '.summary.total_scanned' scan-results.json)
          RATE=$(jq -r '.summary.compliance_rate' scan-results.json)
          
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "compliance_rate=$RATE" >> $GITHUB_OUTPUT
          
          # Fail if there are errors (but allow warnings)
          # Use explicit numeric validation
          if [[ "$ERRORS" =~ ^[0-9]+$ ]] && [ "$ERRORS" -gt 0 ]; then
            echo "status=FAIL" >> $GITHUB_OUTPUT
          else
            echo "status=PASS" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ” å…¨å„²å­˜åº«è­‰æ“šæŽƒæå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æŽƒæçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ¨™ | æ•¸å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¸½æŽƒææª”æ¡ˆæ•¸ | ${{ steps.scan.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ éŒ¯èª¤æ•¸ | ${{ steps.scan.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ è­¦å‘Šæ•¸ | ${{ steps.scan.outputs.warnings }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ åˆè¦çŽ‡ | ${{ steps.scan.outputs.compliance_rate }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.scan.outputs.status }}" = "FAIL" ]; then
            echo "### âŒ æŽƒæç‹€æ…‹ï¼šå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç™¼ç¾ ${{ steps.scan.outputs.errors }} å€‹éŒ¯èª¤éœ€è¦ä¿®æ­£ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… æŽƒæç‹€æ…‹ï¼šé€šéŽ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰æª”æ¡ˆå‡ç¬¦åˆè­‰æ“šè¦ç¯„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*æŽƒææ™‚é–“: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Scan Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: evidence-scan-results
          path: |
            scan-results.json
            scan-output.txt
          if-no-files-found: ignore
          retention-days: 30
