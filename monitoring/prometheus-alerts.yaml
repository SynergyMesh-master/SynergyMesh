apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: monitoring
  labels:
    app: prometheus
data:
  alerts.yml: |
    groups:
      - name: deployment_health
        interval: 30s
        rules:
          - alert: RolloutDegraded
            expr: argo_rollouts_rollout_phase{phase="Degraded"} == 1
            for: 5m
            labels:
              severity: critical
              component: argo-rollouts
            annotations:
              summary: "Rollout {{ $labels.rollout }} is degraded"
              description: "Rollout {{ $labels.rollout }} has been in degraded state for more than 5 minutes"
              
          - alert: RollbackInitiated
            expr: increase(argo_rollouts_rollback_total[5m]) > 0
            labels:
              severity: warning
              component: argo-rollouts
            annotations:
              summary: "Rollback initiated for {{ $labels.rollout }}"
              description: "Rollback has been triggered for rollout {{ $labels.rollout }}"
              
          - alert: DeploymentTimeout
            expr: time() - argo_rollouts_deploy_start_time_seconds > 3600
            labels:
              severity: warning
              component: argo-rollouts
            annotations:
              summary: "Deployment timeout for {{ $labels.rollout }}"
              description: "Deployment for {{ $labels.rollout }} has been running for over 1 hour"

      - name: application_health
        interval: 30s
        rules:
          - alert: HighErrorRate
            expr: |
              sum(rate(http_requests_total{status=~"5.."}[5m])) 
              / sum(rate(http_requests_total[5m])) > 0.05
            for: 5m
            labels:
              severity: critical
              component: application
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
              
          - alert: LowSuccessRate
            expr: |
              sum(rate(http_requests_total{status=~"2.."}[5m])) 
              / sum(rate(http_requests_total[5m])) < 0.95
            for: 5m
            labels:
              severity: warning
              component: application
            annotations:
              summary: "Low success rate detected"
              description: "Success rate is {{ $value | humanizePercentage }} (threshold: 95%)"
              
          - alert: HighResponseTime
            expr: |
              histogram_quantile(0.95, 
                sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
              ) > 0.5
            for: 10m
            labels:
              severity: warning
              component: application
            annotations:
              summary: "High P95 response time"
              description: "P95 response time is {{ $value }}s (threshold: 0.5s)"

      - name: canary_analysis
        interval: 30s
        rules:
          - alert: CanaryFailureRateTooHigh
            expr: |
              sum(rate(http_requests_total{status=~"5..", endpoint="canary"}[5m]))
              / sum(rate(http_requests_total{endpoint="canary"}[5m])) > 0.02
            for: 5m
            labels:
              severity: critical
              component: canary
            annotations:
              summary: "Canary failure rate too high"
              description: "Canary failure rate is {{ $value | humanizePercentage }} (threshold: 2%)"
              
          - alert: CanaryResponseTimeDegraded
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{endpoint="canary"}[5m])) by (le)
              ) > histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{endpoint="stable"}[5m])) by (le)
              ) * 1.5
            for: 10m
            labels:
              severity: warning
              component: canary
            annotations:
              summary: "Canary response time degraded compared to stable"
              description: "Canary P95 response time is 50% higher than stable"

      - name: resource_usage
        interval: 60s
        rules:
          - alert: HighCPUUsage
            expr: |
              sum(rate(container_cpu_usage_seconds_total{pod=~"machine-native-ops.*"}[5m])) 
              / sum(kube_pod_container_resource_limits{resource="cpu", pod=~"machine-native-ops.*"}) > 0.8
            for: 10m
            labels:
              severity: warning
              component: resources
            annotations:
              summary: "High CPU usage for {{ $labels.pod }}"
              description: "CPU usage is {{ $value | humanizePercentage }} of limit"
              
          - alert: HighMemoryUsage
            expr: |
              sum(container_memory_working_set_bytes{pod=~"machine-native-ops.*"})
              / sum(kube_pod_container_resource_limits{resource="memory", pod=~"machine-native-ops.*"}) > 0.85
            for: 10m
            labels:
              severity: warning
              component: resources
            annotations:
              summary: "High memory usage for {{ $labels.pod }}"
              description: "Memory usage is {{ $value | humanizePercentage }} of limit"
              
          - alert: PodCrashLooping
            expr: |
              increase(kube_pod_container_status_restarts_total{pod=~"machine-native-ops.*"}[1h]) > 5
            labels:
              severity: critical
              component: resources
            annotations:
              summary: "Pod {{ $labels.pod }} is crash looping"
              description: "Pod has restarted {{ $value }} times in the last hour"

      - name: security_alerts
        interval: 60s
        rules:
          - alert: UnauthorizedAccessAttempts
            expr: |
              sum(rate(http_requests_total{status="401"}[5m])) > 10
            for: 5m
            labels:
              severity: warning
              component: security
            annotations:
              summary: "High rate of unauthorized access attempts"
              description: "{{ $value | humanize }} unauthorized requests per second"
              
          - alert: TooManyRequests
            expr: |
              sum(rate(http_requests_total{status="429"}[5m])) > 50
            for: 5m
            labels:
              severity: warning
              component: security
            annotations:
              summary: "High rate of rate-limited requests"
              description: "{{ $value | humanize }} requests are being rate-limited per second"