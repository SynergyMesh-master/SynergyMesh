apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: machine-native-ops
  namespace: default
  labels:
    app: machine-native-ops
    version: v1
spec:
  replicas: 5
  strategy:
    canary:
      # Canary service that points to canary pods
      canaryService: machine-native-ops-canary
      # Stable service that points to stable pods
      stableService: machine-native-ops-stable
      # Traffic routing configuration
      trafficRouting:
        nginx:
          stableService: machine-native-ops-stable
          canaryService: machine-native-ops-canary
          annotationPrefix: nginx.ingress.kubernetes.io
      
      # Canary deployment steps
      steps:
        # Initial 10% traffic to canary
        - setWeight: 10
        # Pause for 5 minutes for manual verification
        - pause: {duration: 5m}
        
        # Increase to 30% traffic
        - setWeight: 30
        # Pause for automatic metrics analysis
        - pause: {duration: 10m}
        
        # Increase to 50% traffic
        - setWeight: 50
        # Extended pause for thorough testing
        - pause: {duration: 15m}
        
        # Increase to 80% traffic
        - setWeight: 80
        # Final pause before full rollout
        - pause: {duration: 10m}
        
        # Full rollout (100% traffic)
        - setWeight: 100
      
      # Analysis templates for automated validation
      analysis:
        templates:
          - templateName: success-rate
          - templateName: error-rate
          - templateName: response-time
        args:
          - name: service-name
            value: machine-native-ops
        # Start analysis from step 2
        startingStep: 2
        # Maximum number of successful analysis runs
        successfulRunHistoryLimit: 3
        # Maximum number of failed analysis runs
        unsuccessfulRunHistoryLimit: 1
  
  revisionHistoryLimit: 10
  
  selector:
    matchLabels:
      app: machine-native-ops
  
  template:
    metadata:
      labels:
        app: machine-native-ops
        version: v1
    spec:
      containers:
        - name: machine-native-ops
          image: ghcr.io/machinenativeops/machine-native-ops:latest
          imagePullPolicy: Always
          
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          
          # Resource limits and requests
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          
          # Health checks
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          # Environment variables
          env:
            - name: APP_ENV
              value: "production"
            - name: LOG_LEVEL
              value: "info"
          
          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true