#!/bin/bash

# Auto-commit and PR workflow script
# æ¯æ¬¡å®Œæˆé‡è¦å·¥ä½œå¾ŒåŸ·è¡Œ

set -e

echo "ğŸ”„ Auto-commit and PR workflow starting..."

# æª¢æŸ¥æ˜¯å¦åœ¨ Git å€‰åº«ä¸­
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
fi

# æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
if [[ -z $(git status --porcelain) ]]; then
    echo "âœ… No changes to commit"
    exit 0
fi

# ç”Ÿæˆæ™‚é–“æˆ³
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BRANCH_NAME="auto-arch-${TIMESTAMP}"

# è‡ªå‹•æ·»åŠ æ‰€æœ‰è®Šæ›´
echo "ğŸ“ Adding all changes..."
git add .

# ç”Ÿæˆæ™ºèƒ½æäº¤ä¿¡æ¯
echo "ğŸ“‹ Generating commit message..."
CHANGES=$(git diff --cached --name-only | sed 's/^/- /')

COMMIT_MSG="feat: ${TIMESTAMP} - Auto-architectural improvements

ğŸ“‹ Changes:
${CHANGES}

ğŸ¤– Generated by SuperNinja workflow
ğŸ“ This commit ensures all architectural work is preserved in PR"

# æäº¤è®Šæ›´
echo "ğŸ’¾ Committing changes..."
git commit -m "$COMMIT_MSG"

# å‰µå»ºä¸¦åˆ‡æ›åˆ°æ–°åˆ†æ”¯
echo "ğŸŒ¿ Creating branch ${BRANCH_NAME}..."
git checkout -b $BRANCH_NAME

# æ¨é€åˆ°é ç¨‹
echo "ğŸ“¤ Pushing to remote..."
git push -u origin $BRANCH_NAME

# æª¢æŸ¥æ˜¯å¦æœ‰ GitHub CLI
if command -v gh &> /dev/null; then
    echo "ğŸ”€ Creating Pull Request..."
    gh pr create \
        --title "Auto-architectural updates ${TIMESTAMP}" \
        --body "ğŸ¤– Automated architectural improvements

This PR contains:
- File system governance enhancements
- Validation system improvements
- Policy updates and refactoring

**Generated by SuperNinja workflow at ${TIMESTAMP}**

## ğŸ“Š Summary
- All changes automatically committed and tracked
- Ensures no architectural work is lost
- Follows enterprise-grade development practices

## âœ… Next Steps
1. Review the changes
2. Run tests if applicable
3. Merge after approval" \
        --assignee @me \
        --label "auto-generated,architectural"
    
    echo "âœ… Pull Request created successfully!"
else
    echo "âš ï¸  GitHub CLI not found. Please create PR manually:"
    echo "   Branch: ${BRANCH_NAME}"
    echo "   Or install GitHub CLI: https://cli.github.com/"
fi

echo "ğŸ‰ Auto-commit and PR workflow completed!"
echo "ğŸ“‹ Summary:"
echo "   - Changes committed: ${COMMIT_MSG}"
echo "   - Branch created: ${BRANCH_NAME}"
echo "   - Remote push: âœ…"
echo "   - PR status: $([ -x "$(command -v gh)" ] && echo "âœ… Created" || echo "âš ï¸  Manual")"