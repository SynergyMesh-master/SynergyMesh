%YAML 1.2
---
# ═══════════════════════════════════════════════════════════════════════════
#                    Rollback Management Framework v1.0
#                    Simplified, Production-Ready Recovery
# ═══════════════════════════════════════════════════════════════════════════
#
# Purpose: Define rollback procedures for migration operations
# Approach: Manual snapshot-based (simplified for documentation)
# Compliance: ITIL Change Management, ISO-22301
#
# ═══════════════════════════════════════════════════════════════════════════

rollback_policy:
  version: "1.0.0"
  enabled: true
  strategy: "MANUAL_SNAPSHOT"
  
  # ═════════════════════════════════════════════════════════════════════════
  # Snapshot Configuration (Simplified)
  # ═════════════════════════════════════════════════════════════════════════
  snapshot:
    format: "tar.gz"
    compression: "gzip"
    encryption: false  # Not needed for internal documentation
    integrity: "sha256"
    
    # Snapshot metadata
    metadata_format: "json"
    include_metadata: true
    metadata_fields:
      - snapshot_id
      - timestamp
      - source_path
      - file_count
      - total_size
      - sha256_checksum
  
  # ═════════════════════════════════════════════════════════════════════════
  # Retention Policy
  # ═════════════════════════════════════════════════════════════════════════
  retention:
    default_ttl: "30d"
    location: "workspace/mcp/namespace-mcp/refactor_playbooks/_snapshots/"
    
    # Retention tiers
    tiers:
      immediate: "7d"    # Keep last 7 days immediately accessible
      archive: "30d"     # Archive for 30 days total
      permanent: false   # No permanent retention for docs
    
    # Cleanup policy
    cleanup:
      enabled: true
      schedule: "weekly"
      keep_minimum: 2  # Always keep at least 2 snapshots

  # ═════════════════════════════════════════════════════════════════════════
  # Rollback Triggers (Manual Only)
  # ═════════════════════════════════════════════════════════════════════════
  triggers:
    manual_only: true
    
    # Conditions that suggest rollback may be needed
    warning_conditions:
      - condition: "integrity_score < 0.95"
        severity: "MEDIUM"
        action: "ALERT_ADMIN"
        message: "Consider manual rollback - integrity score below threshold"
      
      - condition: "validation_failure_count > 3"
        severity: "HIGH"
        action: "ALERT_ADMIN"
        message: "Multiple validation failures - manual rollback recommended"
      
      - condition: "user_reported_issue"
        severity: "VARIABLE"
        action: "EVALUATE"
        message: "User reported issue - evaluate need for rollback"

  # ═════════════════════════════════════════════════════════════════════════
  # Rollback Procedure (Manual Steps)
  # ═════════════════════════════════════════════════════════════════════════
  rollback_procedure:
    type: "MANUAL"
    estimated_time: "5 minutes"
    
    steps:
      - step: 1
        action: "Identify snapshot"
        command: "ls -lh _snapshots/"
        description: "List available snapshots and select target"
      
      - step: 2
        action: "Verify snapshot integrity"
        command: "sha256sum -c snapshot.sha256"
        description: "Verify snapshot has not been corrupted"
      
      - step: 3
        action: "Backup current state"
        command: "tar -czf current_backup.tar.gz refactor_playbooks/"
        description: "Create backup of current state before rollback"
      
      - step: 4
        action: "Extract snapshot"
        command: "tar -xzf snapshot.tar.gz"
        description: "Extract snapshot to temporary location"
      
      - step: 5
        action: "Restore files"
        command: "rsync -av --delete snapshot/ target/"
        description: "Restore files from snapshot to target location"
      
      - step: 6
        action: "Validate restoration"
        command: "python3 validate_migration.py"
        description: "Run validation to ensure successful restoration"
      
      - step: 7
        action: "Update indices"
        command: "python3 update_indices.py"
        description: "Update NAMESPACE_INDEX and INTEGRATION_INDEX"
      
      - step: 8
        action: "Document rollback"
        command: "echo 'Rollback completed' >> rollback.log"
        description: "Document rollback in audit log"
    
    # Validation after rollback
    post_rollback_validation:
      - check: "file_count"
        description: "Verify all files restored"
        threshold: 1.0
      
      - check: "integrity"
        description: "Verify file integrity"
        threshold: 1.0
      
      - check: "accessibility"
        description: "Verify files are accessible"
        threshold: 1.0

  # ═════════════════════════════════════════════════════════════════════════
  # Disaster Recovery
  # ═════════════════════════════════════════════════════════════════════════
  disaster_recovery:
    rto: "5 minutes"   # Recovery Time Objective
    rpo: "0 minutes"   # Recovery Point Objective (no data loss)
    
    test_schedule:
      frequency: "quarterly"
      last_test: "2026-01-08"
      next_test: "2026-04-08"
    
    test_scenarios:
      - scenario: "Complete data loss"
        procedure: "Restore from most recent snapshot"
        expected_time: "2 minutes"
        success_criteria:
          - "All files restored"
          - "Integrity verified"
          - "Indices updated"
      
      - scenario: "Partial corruption"
        procedure: "Selective restore from snapshot"
        expected_time: "1 minute"
        success_criteria:
          - "Corrupted files replaced"
          - "Integrity verified"
      
      - scenario: "Accidental deletion"
        procedure: "Restore deleted files from snapshot"
        expected_time: "1 minute"
        success_criteria:
          - "Deleted files restored"
          - "No additional changes"

# ═══════════════════════════════════════════════════════════════════════════
# Snapshot Management
# ═══════════════════════════════════════════════════════════════════════════
snapshot_management:
  creation:
    timing: "pre_migration"
    automatic: false
    manual_trigger: true
    
    command: |
      # Create snapshot
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      tar -czf _snapshots/snapshot_${TIMESTAMP}.tar.gz refactor_playbooks/
      
      # Calculate checksum
      sha256sum _snapshots/snapshot_${TIMESTAMP}.tar.gz > _snapshots/snapshot_${TIMESTAMP}.sha256
      
      # Create metadata
      cat > _snapshots/snapshot_${TIMESTAMP}.json << EOF
      {
        "snapshot_id": "snapshot_${TIMESTAMP}",
        "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "source_path": "workspace/mcp/namespace-mcp/refactor_playbooks/",
        "file_count": $(find refactor_playbooks/ -type f | wc -l),
        "total_size": "$(du -sh refactor_playbooks/ | cut -f1)",
        "sha256_checksum": "$(cat _snapshots/snapshot_${TIMESTAMP}.sha256)"
      }
      EOF
  
  verification:
    command: |
      # Verify snapshot integrity
      sha256sum -c snapshot.sha256
      
      # Verify snapshot can be extracted
      tar -tzf snapshot.tar.gz > /dev/null
  
  restoration:
    command: |
      # Restore from snapshot
      SNAPSHOT_FILE=$1
      
      # Verify integrity first
      sha256sum -c ${SNAPSHOT_FILE}.sha256
      
      # Create backup of current state
      tar -czf current_backup_$(date +%Y%m%d_%H%M%S).tar.gz refactor_playbooks/
      
      # Extract snapshot
      tar -xzf ${SNAPSHOT_FILE}
      
      # Validate restoration
      echo "Restoration complete. Please verify manually."

# ═══════════════════════════════════════════════════════════════════════════
# Compliance Mapping
# ═══════════════════════════════════════════════════════════════════════════
compliance_mapping:
  ITIL:
    - process: "Change Management"
      requirement: "Rollback plan for all changes"
      implementation: "Manual rollback procedure with documented steps"
      evidence: "ROLLBACK_MANAGEMENT.yaml"
  
  ISO22301:
    - control: "Business Continuity"
      requirement: "Recovery procedures documented and tested"
      implementation: "DR test scenarios with quarterly testing"
      evidence: "disaster_recovery section"
  
  ISO27001:
    - control: "A.17.1.3"
      description: "Verify, review and evaluate information security continuity"
      implementation: "Quarterly DR testing with documented procedures"
      evidence: "test_schedule and test_scenarios"

# ═══════════════════════════════════════════════════════════════════════════
# Usage Examples
# ═══════════════════════════════════════════════════════════════════════════
usage_examples:
  create_snapshot:
    description: "Create a snapshot before migration"
    command: |
      cd workspace/mcp/namespace-mcp/refactor_playbooks
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      tar -czf _snapshots/snapshot_${TIMESTAMP}.tar.gz .
      sha256sum _snapshots/snapshot_${TIMESTAMP}.tar.gz > _snapshots/snapshot_${TIMESTAMP}.sha256
  
  list_snapshots:
    description: "List all available snapshots"
    command: |
      ls -lh _snapshots/snapshot_*.tar.gz
  
  verify_snapshot:
    description: "Verify snapshot integrity"
    command: |
      cd _snapshots
      sha256sum -c snapshot_20260108_170000.sha256
  
  restore_snapshot:
    description: "Restore from snapshot"
    command: |
      # Backup current state first
      tar -czf current_backup.tar.gz refactor_playbooks/
      
      # Restore from snapshot
      tar -xzf _snapshots/snapshot_20260108_170000.tar.gz
      
      # Verify restoration
      echo "Please verify files manually"

# ═══════════════════════════════════════════════════════════════════════════
# Monitoring and Alerting
# ═══════════════════════════════════════════════════════════════════════════
monitoring:
  snapshot_health:
    checks:
      - metric: "snapshot_age"
        threshold: "7d"
        alert: "No recent snapshot - create new snapshot"
      
      - metric: "snapshot_integrity"
        threshold: "100%"
        alert: "Snapshot integrity check failed"
      
      - metric: "storage_usage"
        threshold: "80%"
        alert: "Snapshot storage usage high - cleanup needed"
  
  rollback_readiness:
    checks:
      - metric: "snapshot_availability"
        threshold: ">=2"
        alert: "Less than 2 snapshots available"
      
      - metric: "last_dr_test"
        threshold: "90d"
        alert: "DR test overdue - schedule test"

---
# Rollback Management Status: DEFINED
# Strategy: Manual snapshot-based (simplified)
# Compliance: ITIL, ISO-22301, ISO-27001
# Implementation: READY
# Next Steps: Create initial snapshot, test rollback procedure